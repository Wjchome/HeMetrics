# 心跳机制说明

## 概述

心跳机制用于保持客户端与服务器之间的TCP连接活跃，防止连接因长时间无数据交互而被网络设备（如路由器、防火墙）断开。

## 实现细节

### 心跳参数

- **ModuleId**: `2147483648` (1 << 31) - 内部服务模块ID
- **RouterId**: `2147483648` (1 << 31) - 心跳路由ID
- **消息类型**: 事件（Event，isOneWay=true，不需要响应）
- **消息体**: 空（0字节）
- **发送间隔**: 默认 2 秒（可在 Inspector 中配置）

### 工作流程

1. **连接建立后自动启动**
   - 当 `Connect()` 成功连接服务器后，自动启动心跳线程

2. **定期发送心跳**
   - 心跳线程每 2 秒（可配置）发送一次心跳包
   - 心跳包使用 `SendEvent()` 方法发送，不等待响应

3. **连接断开时自动停止**
   - 当连接断开或调用 `Disconnect()` 时，心跳线程自动停止

## Unity Inspector 配置

在 Unity Editor 中，可以在 NetManager 组件的 Inspector 面板配置：

- **Keep Alive Interval**: 心跳间隔（秒），默认 2.0
- **Log Keep Alive**: 是否输出心跳日志，默认 false（避免日志过多）

## 代码示例

```csharp
// 心跳会自动启动，无需手动调用
// 连接成功后，心跳线程会自动运行

// 如果需要手动停止心跳，可以断开连接
netManager.Disconnect();
```

## 与 Go 服务器的一致性

Unity 客户端的心跳实现与 Go 服务器完全一致：

- 使用相同的 ModuleId 和 RouterId
- 使用相同的消息格式（空消息体，isOneWay=true）
- 使用相同的发送间隔（2秒）

## 注意事项

1. **性能考虑**
   - 心跳间隔不宜过短（会增加网络流量）
   - 心跳间隔不宜过长（可能导致连接被断开）
   - 推荐值：2-5 秒

2. **日志输出**
   - 默认不输出心跳日志（`logKeepAlive = false`）
   - 调试时可以开启日志查看心跳状态

3. **线程安全**
   - 心跳在独立线程中运行
   - 使用 `isConnected` 标志控制线程生命周期
   - 断开连接时会等待心跳线程结束

## 故障排查

如果连接频繁断开，检查：

1. **心跳间隔是否合适**
   - 如果间隔太长，可能在心跳发送前连接就被断开
   - 建议设置为 2-3 秒

2. **网络环境**
   - 某些网络环境（如移动网络）可能对空闲连接有更严格的超时限制
   - 可以适当缩短心跳间隔

3. **服务器配置**
   - 确保服务器端的心跳处理正常
   - 检查服务器日志确认收到心跳包



