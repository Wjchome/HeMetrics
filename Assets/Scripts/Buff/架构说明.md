# Buff系统架构说明

## 架构层次

```
Character (角色行为层)
    ↓
BondManager (羁绊管理 - 配置层，无行为)
    ↓
BuffManager (Buff管理 - 行为层)
    ↓
BuffInstance (单个Buff实例 - 行为层)
    ↓
AttributeManager (属性管理 - 底层，已实现)
```

## 各层职责

### 1. Character（角色层）
- **职责**：角色的游戏行为（移动、攻击等）
- **状态**：已确定，不需要修改

### 2. BondManager（羁绊管理层）
- **职责**：
  - 管理羁绊配置（bondsConfig）
  - 管理当前激活的羁绊（currentBonds）
  - 计算羁绊等级
- **特点**：**纯配置层，无行为**，只负责数据管理

### 3. BuffManager（Buff管理层）
- **职责**：
  - 管理角色身上的所有Buff实例
  - 添加/移除Buff
  - 更新Buff状态（每帧调用）
  - 管理Buff生命周期
- **特点**：**行为层**，负责Buff的生命周期管理

### 4. BuffInstance（Buff实例层）
- **职责**：
  - 单个Buff的行为实现
  - 根据BuffData计算属性加成
  - 处理条件判断（IsActive）
  - 处理临时Buff（IsExpired）
  - 与AttributeManager交互
- **特点**：**行为层**，每个Buff都是独立的实例

### 5. AttributeManager（属性管理层）
- **职责**：
  - 底层属性管理
  - 记录所有属性来源
  - 计算最终属性值
  - 显示中间过程
- **特点**：**已实现，不需要修改**

## 数据流

```
BondData (配置)
    ↓
BondManager.ChangeCharacter()
    ↓
计算羁绊等级
    ↓
BondBuffHandler.ApplyBondBuffs()
    ↓
BuffManager.AddBuff(BuffData, source)
    ↓
创建BuffInstance
    ↓
BuffInstance.ApplyToAttributeManager()
    ↓
AttributeManager.Add(attributeName, source, value)
    ↓
Character.UpdateAttributes()
    ↓
更新角色属性
```

## 优势

### ✅ 清晰的职责分离
- **Bond**：配置数据，无行为
- **Buff**：行为层，有状态和逻辑
- **AttributeManager**：底层存储，无业务逻辑

### ✅ 中间状态明确
- BuffInstance是明确的中间状态
- 可以追踪每个Buff的状态（激活/过期）
- 可以独立管理每个Buff的生命周期

### ✅ 易于扩展
- 添加新的Buff类型：实现IBuff接口
- 添加条件Buff：在BuffInstance.IsActive()中实现
- 添加临时Buff：使用Param2作为持续时间

### ✅ 支持复杂Buff
- 条件Buff：在IsActive()中判断
- 临时Buff：在IsExpired()中判断
- 动态Buff：在GetAttributeBonus()中动态计算

## 使用示例

### 添加羁绊Buff
```csharp
// BondManager中
BondBuffHandler.ApplyBondBuffs(character, bondData, bondLevel);
// ↓
// BuffManager中
buffManager.AddBuff(buffData, "羁绊_攻击_Lv2");
// ↓
// 创建BuffInstance
// ↓
// 自动应用到AttributeManager
```

### 添加其他来源的Buff
```csharp
// 技能Buff
character.buffManager.AddBuff(skillBuffData, "技能_狂暴");

// 装备Buff
character.buffManager.AddBuff(equipmentBuffData, "装备_剑");
```

### 移除Buff
```csharp
// 移除指定Buff
character.buffManager.RemoveBuff(buffId);

// 移除所有羁绊Buff
character.buffManager.RemoveBuffsBySource("羁绊");
```

## 扩展方向

### 条件Buff示例
```csharp
// 在BuffInstance.IsActive()中
public bool IsActive(Character character)
{
    // 半血以下激活
    if (buffData.UseType == 特殊条件)
    {
        float hpPercent = (float)character.HP / character.MaxHP;
        return hpPercent < 0.5f;
    }
    return true;
}
```

### 临时Buff示例
```csharp
// Param2 > 0 表示持续时间（毫秒）
// 在BuffInstance.IsExpired()中自动处理
```

## 总结

现在的架构：
- ✅ **Character**：行为已确定
- ✅ **Bond**：纯配置，无行为
- ✅ **Buff**：有行为层（BuffManager + BuffInstance）
- ✅ **AttributeManager**：底层属性管理

架构清晰，职责明确，易于维护和扩展！

